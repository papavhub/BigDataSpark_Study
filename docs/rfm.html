

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>13. RFM Analysis &mdash; Learning Apache Spark with Python  documentation</title>
  

  
  
    <link rel="shortcut icon" href="_static/icon.ico"/>
  
  
  

  
  <script type="text/javascript" src="_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/language_data.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/fix_rtd.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="14. Text Mining" href="textmining.html" />
    <link rel="prev" title="12. Clustering" href="clustering.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> Learning Apache Spark with Python
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="preface.html">1. Preface</a></li>
<li class="toctree-l1"><a class="reference internal" href="why.html">2. Why Spark with Python ?</a></li>
<li class="toctree-l1"><a class="reference internal" href="setup.html">3. Configure Running Platform</a></li>
<li class="toctree-l1"><a class="reference internal" href="introduction.html">4. An Introduction to Apache Spark</a></li>
<li class="toctree-l1"><a class="reference internal" href="rdd.html">5. Programming with RDDs</a></li>
<li class="toctree-l1"><a class="reference internal" href="stats.html">6. Statistics and Linear Algebra Preliminaries</a></li>
<li class="toctree-l1"><a class="reference internal" href="exploration.html">7. Data Exploration</a></li>
<li class="toctree-l1"><a class="reference internal" href="manipulation.html">8. Data Manipulation: Features</a></li>
<li class="toctree-l1"><a class="reference internal" href="regression.html">9. Regression</a></li>
<li class="toctree-l1"><a class="reference internal" href="reg.html">10. Regularization</a></li>
<li class="toctree-l1"><a class="reference internal" href="classification.html">11. Classification</a></li>
<li class="toctree-l1"><a class="reference internal" href="clustering.html">12. Clustering</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">13. RFM Analysis</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#rfm-analysis-methodology">13.1. RFM Analysis Methodology</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#build-the-rfm-features-matrix-for-each-customer">13.1.1. 1. Build the RFM features matrix for each customer</a></li>
<li class="toctree-l3"><a class="reference internal" href="#determine-cutting-points-for-each-feature">13.1.2. 2. Determine cutting points for each feature</a></li>
<li class="toctree-l3"><a class="reference internal" href="#determine-the-rfm-scores-and-summarize-the-corresponding-business-value">13.1.3. 3. Determine the RFM scores and summarize the corresponding business value</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#demo">13.2. Demo</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#load-and-clean-data">13.2.1. Load and clean data</a></li>
<li class="toctree-l3"><a class="reference internal" href="#rfm-segmentation">13.2.2. RFM Segmentation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#statistical-summary">13.2.3. Statistical Summary</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#extension">13.3. Extension</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#build-feature-matrix">13.3.1. Build feature matrix</a></li>
<li class="toctree-l3"><a class="reference internal" href="#k-means-clustering">13.3.2. K-means clustering</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id1">13.3.3. Statistical summary</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="textmining.html">14. Text Mining</a></li>
<li class="toctree-l1"><a class="reference internal" href="socialnetwork.html">15. Social Network Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="als.html">16. ALS: Stock Portfolio Recommendations</a></li>
<li class="toctree-l1"><a class="reference internal" href="mc.html">17. Monte Carlo Simulation</a></li>
<li class="toctree-l1"><a class="reference internal" href="mcmc.html">18. Markov Chain Monte Carlo</a></li>
<li class="toctree-l1"><a class="reference internal" href="fnn.html">19. Neural Network</a></li>
<li class="toctree-l1"><a class="reference internal" href="auto.html">20. Automation for Cloudera Distribution Hadoop</a></li>
<li class="toctree-l1"><a class="reference internal" href="pack.html">21. Wrap PySpark Package</a></li>
<li class="toctree-l1"><a class="reference internal" href="audit.html">22. PySpark Data Audit Library</a></li>
<li class="toctree-l1"><a class="reference internal" href="ze2nb.html">23. Zeppelin to jupyter notebook</a></li>
<li class="toctree-l1"><a class="reference internal" href="cheat.html">24. My Cheat Sheet</a></li>
<li class="toctree-l1"><a class="reference internal" href="jdbc.html">25. JDBC Connection</a></li>
<li class="toctree-l1"><a class="reference internal" href="bricks.html">26. Databricks Tips</a></li>
<li class="toctree-l1"><a class="reference internal" href="api.html">27. PySpark API</a></li>
<li class="toctree-l1"><a class="reference internal" href="reference.html">28. Main Reference</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Learning Apache Spark with Python</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li><span class="section-number">13. </span>RFM Analysis</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="rfm-analysis">
<span id="rfm"></span><h1><span class="section-number">13. </span>RFM Analysis<a class="headerlink" href="#rfm-analysis" title="Permalink to this headline">¶</a></h1>
<div class="figure align-center">
<img alt="_images/rfm_business.png" src="_images/rfm_business.png" />
</div>
<p>The above figure source: Blast Analytics Marketing</p>
<p>RFM is a method used for analyzing customer value. It is commonly used in database marketing and direct marketing and has received particular attention in retail and professional services industries. More details can be found at
Wikipedia <a class="reference external" href="https://en.wikipedia.org/wiki/RFM_(customer_value)">RFM_wikipedia</a>.</p>
<p>RFM stands for the three dimensions:</p>
<ul class="simple">
<li><p>Recency – How recently did the customer purchase? i.e. Duration since last purchase</p></li>
<li><p>Frequency – How often do they purchase?  i.e. Total number of purchases</p></li>
<li><p>Monetary Value – How much do they spend? i.e. Total money this customer spent</p></li>
</ul>
<div class="section" id="rfm-analysis-methodology">
<h2><span class="section-number">13.1. </span>RFM Analysis Methodology<a class="headerlink" href="#rfm-analysis-methodology" title="Permalink to this headline">¶</a></h2>
<p>RFM Analysis contains three main steps:</p>
<div class="section" id="build-the-rfm-features-matrix-for-each-customer">
<h3><span class="section-number">13.1.1. </span>1. Build the RFM features matrix for each customer<a class="headerlink" href="#build-the-rfm-features-matrix-for-each-customer" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">+----------+-------+---------+---------+</span>
<span class="o">|</span><span class="n">CustomerID</span><span class="o">|</span><span class="n">Recency</span><span class="o">|</span><span class="n">Frequency</span><span class="o">|</span> <span class="n">Monetary</span><span class="o">|</span>
<span class="o">+----------+-------+---------+---------+</span>
<span class="o">|</span>     <span class="mi">14911</span><span class="o">|</span>      <span class="mi">1</span><span class="o">|</span>      <span class="mi">248</span><span class="o">|</span><span class="mf">132572.62</span><span class="o">|</span>
<span class="o">|</span>     <span class="mi">12748</span><span class="o">|</span>      <span class="mi">0</span><span class="o">|</span>      <span class="mi">224</span><span class="o">|</span>  <span class="mf">29072.1</span><span class="o">|</span>
<span class="o">|</span>     <span class="mi">17841</span><span class="o">|</span>      <span class="mi">1</span><span class="o">|</span>      <span class="mi">169</span><span class="o">|</span> <span class="mf">40340.78</span><span class="o">|</span>
<span class="o">|</span>     <span class="mi">14606</span><span class="o">|</span>      <span class="mi">1</span><span class="o">|</span>      <span class="mi">128</span><span class="o">|</span> <span class="mf">11713.85</span><span class="o">|</span>
<span class="o">|</span>     <span class="mi">15311</span><span class="o">|</span>      <span class="mi">0</span><span class="o">|</span>      <span class="mi">118</span><span class="o">|</span> <span class="mf">59419.34</span><span class="o">|</span>
<span class="o">+----------+-------+---------+---------+</span>
<span class="n">only</span> <span class="n">showing</span> <span class="n">top</span> <span class="mi">5</span> <span class="n">rows</span>
</pre></div>
</div>
</div>
<div class="section" id="determine-cutting-points-for-each-feature">
<h3><span class="section-number">13.1.2. </span>2. Determine cutting points for each feature<a class="headerlink" href="#determine-cutting-points-for-each-feature" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">+----------+-------+---------+--------+-----+-----+-----+</span>
<span class="o">|</span><span class="n">CustomerID</span><span class="o">|</span><span class="n">Recency</span><span class="o">|</span><span class="n">Frequency</span><span class="o">|</span><span class="n">Monetary</span><span class="o">|</span><span class="n">r_seg</span><span class="o">|</span><span class="n">f_seg</span><span class="o">|</span><span class="n">m_seg</span><span class="o">|</span>
<span class="o">+----------+-------+---------+--------+-----+-----+-----+</span>
<span class="o">|</span>     <span class="mi">17420</span><span class="o">|</span>     <span class="mi">50</span><span class="o">|</span>        <span class="mi">3</span><span class="o">|</span>  <span class="mf">598.83</span><span class="o">|</span>    <span class="mi">2</span><span class="o">|</span>    <span class="mi">3</span><span class="o">|</span>    <span class="mi">2</span><span class="o">|</span>
<span class="o">|</span>     <span class="mi">16861</span><span class="o">|</span>     <span class="mi">59</span><span class="o">|</span>        <span class="mi">3</span><span class="o">|</span>  <span class="mf">151.65</span><span class="o">|</span>    <span class="mi">3</span><span class="o">|</span>    <span class="mi">3</span><span class="o">|</span>    <span class="mi">1</span><span class="o">|</span>
<span class="o">|</span>     <span class="mi">16503</span><span class="o">|</span>    <span class="mi">106</span><span class="o">|</span>        <span class="mi">5</span><span class="o">|</span> <span class="mf">1421.43</span><span class="o">|</span>    <span class="mi">3</span><span class="o">|</span>    <span class="mi">2</span><span class="o">|</span>    <span class="mi">3</span><span class="o">|</span>
<span class="o">|</span>     <span class="mi">15727</span><span class="o">|</span>     <span class="mi">16</span><span class="o">|</span>        <span class="mi">7</span><span class="o">|</span> <span class="mf">5178.96</span><span class="o">|</span>    <span class="mi">1</span><span class="o">|</span>    <span class="mi">1</span><span class="o">|</span>    <span class="mi">4</span><span class="o">|</span>
<span class="o">|</span>     <span class="mi">17389</span><span class="o">|</span>      <span class="mi">0</span><span class="o">|</span>       <span class="mi">43</span><span class="o">|</span><span class="mf">31300.08</span><span class="o">|</span>    <span class="mi">1</span><span class="o">|</span>    <span class="mi">1</span><span class="o">|</span>    <span class="mi">4</span><span class="o">|</span>
<span class="o">+----------+-------+---------+--------+-----+-----+-----+</span>
<span class="n">only</span> <span class="n">showing</span> <span class="n">top</span> <span class="mi">5</span> <span class="n">rows</span>
</pre></div>
</div>
</div>
<div class="section" id="determine-the-rfm-scores-and-summarize-the-corresponding-business-value">
<h3><span class="section-number">13.1.3. </span>3. Determine the RFM scores and summarize the corresponding business value<a class="headerlink" href="#determine-the-rfm-scores-and-summarize-the-corresponding-business-value" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">+----------+-------+---------+--------+-----+-----+-----+--------+</span>
<span class="o">|</span><span class="n">CustomerID</span><span class="o">|</span><span class="n">Recency</span><span class="o">|</span><span class="n">Frequency</span><span class="o">|</span><span class="n">Monetary</span><span class="o">|</span><span class="n">r_seg</span><span class="o">|</span><span class="n">f_seg</span><span class="o">|</span><span class="n">m_seg</span><span class="o">|</span><span class="n">RFMScore</span><span class="o">|</span>
<span class="o">+----------+-------+---------+--------+-----+-----+-----+--------+</span>
<span class="o">|</span>     <span class="mi">17988</span><span class="o">|</span>     <span class="mi">11</span><span class="o">|</span>        <span class="mi">8</span><span class="o">|</span>  <span class="mf">191.17</span><span class="o">|</span>    <span class="mi">1</span><span class="o">|</span>    <span class="mi">1</span><span class="o">|</span>    <span class="mi">1</span><span class="o">|</span>     <span class="mi">111</span><span class="o">|</span>
<span class="o">|</span>     <span class="mi">16892</span><span class="o">|</span>      <span class="mi">1</span><span class="o">|</span>        <span class="mi">7</span><span class="o">|</span>  <span class="mf">496.84</span><span class="o">|</span>    <span class="mi">1</span><span class="o">|</span>    <span class="mi">1</span><span class="o">|</span>    <span class="mi">2</span><span class="o">|</span>     <span class="mi">112</span><span class="o">|</span>
<span class="o">|</span>     <span class="mi">16668</span><span class="o">|</span>     <span class="mi">15</span><span class="o">|</span>        <span class="mi">6</span><span class="o">|</span>  <span class="mf">306.72</span><span class="o">|</span>    <span class="mi">1</span><span class="o">|</span>    <span class="mi">1</span><span class="o">|</span>    <span class="mi">2</span><span class="o">|</span>     <span class="mi">112</span><span class="o">|</span>
<span class="o">|</span>     <span class="mi">16554</span><span class="o">|</span>      <span class="mi">3</span><span class="o">|</span>        <span class="mi">7</span><span class="o">|</span>  <span class="mf">641.55</span><span class="o">|</span>    <span class="mi">1</span><span class="o">|</span>    <span class="mi">1</span><span class="o">|</span>    <span class="mi">2</span><span class="o">|</span>     <span class="mi">112</span><span class="o">|</span>
<span class="o">|</span>     <span class="mi">16500</span><span class="o">|</span>      <span class="mi">4</span><span class="o">|</span>        <span class="mi">6</span><span class="o">|</span>  <span class="mf">400.86</span><span class="o">|</span>    <span class="mi">1</span><span class="o">|</span>    <span class="mi">1</span><span class="o">|</span>    <span class="mi">2</span><span class="o">|</span>     <span class="mi">112</span><span class="o">|</span>
<span class="o">+----------+-------+---------+--------+-----+-----+-----+--------+</span>
<span class="n">only</span> <span class="n">showing</span> <span class="n">top</span> <span class="mi">5</span> <span class="n">rows</span>
</pre></div>
</div>
<p>The corresponding business description and marketing value:</p>
<div class="figure align-center" id="id2">
<span id="fig-rfm-business"></span><img alt="_images/rfm_business.png" src="_images/rfm_business.png" />
<p class="caption"><span class="caption-text">Source: Blast Analytics Marketing</span><a class="headerlink" href="#id2" title="Permalink to this image">¶</a></p>
</div>
</div>
</div>
<div class="section" id="demo">
<h2><span class="section-number">13.2. </span>Demo<a class="headerlink" href="#demo" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>The Jupyter notebook can be download from <a class="reference external" href="_static/RFM.ipynb">Data Exploration</a>.</p></li>
<li><p>The data can be downloaf from <a class="reference external" href="_static/OnlineRetail.csv">German Credit</a>.</p></li>
</ul>
<div class="section" id="load-and-clean-data">
<h3><span class="section-number">13.2.1. </span>Load and clean data<a class="headerlink" href="#load-and-clean-data" title="Permalink to this headline">¶</a></h3>
<ol class="arabic simple">
<li><p>Set up spark context and SparkSession</p></li>
</ol>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyspark.sql</span> <span class="kn">import</span> <span class="n">SparkSession</span>

<span class="n">spark</span> <span class="o">=</span> <span class="n">SparkSession</span> \
    <span class="o">.</span><span class="n">builder</span> \
    <span class="o">.</span><span class="n">appName</span><span class="p">(</span><span class="s2">&quot;Python Spark RFM example&quot;</span><span class="p">)</span> \
    <span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="s2">&quot;spark.some.config.option&quot;</span><span class="p">,</span> <span class="s2">&quot;some-value&quot;</span><span class="p">)</span> \
    <span class="o">.</span><span class="n">getOrCreate</span><span class="p">()</span>
</pre></div>
</div>
<ol class="arabic simple" start="2">
<li><p>Load dataset</p></li>
</ol>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">df_raw</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;com.databricks.spark.csv&#39;</span><span class="p">)</span><span class="o">.</span>\
                       <span class="n">options</span><span class="p">(</span><span class="n">header</span><span class="o">=</span><span class="s1">&#39;true&#39;</span><span class="p">,</span> \
                       <span class="n">inferschema</span><span class="o">=</span><span class="s1">&#39;true&#39;</span><span class="p">)</span><span class="o">.</span>\
            <span class="n">load</span><span class="p">(</span><span class="s2">&quot;Online Retail.csv&quot;</span><span class="p">,</span><span class="n">header</span><span class="o">=</span><span class="kc">True</span><span class="p">);</span>
</pre></div>
</div>
<p>check the data set</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">df_raw</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="n">df_raw</span><span class="o">.</span><span class="n">printSchema</span><span class="p">()</span>
</pre></div>
</div>
<p>Then you will get</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">+---------+---------+--------------------+--------+------------+---------+----------+--------------+</span>
<span class="o">|</span><span class="n">InvoiceNo</span><span class="o">|</span><span class="n">StockCode</span><span class="o">|</span>         <span class="n">Description</span><span class="o">|</span><span class="n">Quantity</span><span class="o">|</span> <span class="n">InvoiceDate</span><span class="o">|</span><span class="n">UnitPrice</span><span class="o">|</span><span class="n">CustomerID</span><span class="o">|</span>       <span class="n">Country</span><span class="o">|</span>
<span class="o">+---------+---------+--------------------+--------+------------+---------+----------+--------------+</span>
<span class="o">|</span>   <span class="mi">536365</span><span class="o">|</span>   <span class="mi">85123</span><span class="n">A</span><span class="o">|</span><span class="n">WHITE</span> <span class="n">HANGING</span> <span class="n">HEA</span><span class="o">...|</span>       <span class="mi">6</span><span class="o">|</span><span class="mi">12</span><span class="o">/</span><span class="mi">1</span><span class="o">/</span><span class="mi">10</span> <span class="mi">8</span><span class="p">:</span><span class="mi">26</span><span class="o">|</span>     <span class="mf">2.55</span><span class="o">|</span>     <span class="mi">17850</span><span class="o">|</span><span class="n">United</span> <span class="n">Kingdom</span><span class="o">|</span>
<span class="o">|</span>   <span class="mi">536365</span><span class="o">|</span>    <span class="mi">71053</span><span class="o">|</span> <span class="n">WHITE</span> <span class="n">METAL</span> <span class="n">LANTERN</span><span class="o">|</span>       <span class="mi">6</span><span class="o">|</span><span class="mi">12</span><span class="o">/</span><span class="mi">1</span><span class="o">/</span><span class="mi">10</span> <span class="mi">8</span><span class="p">:</span><span class="mi">26</span><span class="o">|</span>     <span class="mf">3.39</span><span class="o">|</span>     <span class="mi">17850</span><span class="o">|</span><span class="n">United</span> <span class="n">Kingdom</span><span class="o">|</span>
<span class="o">|</span>   <span class="mi">536365</span><span class="o">|</span>   <span class="mi">84406</span><span class="n">B</span><span class="o">|</span><span class="n">CREAM</span> <span class="n">CUPID</span> <span class="n">HEART</span><span class="o">...|</span>       <span class="mi">8</span><span class="o">|</span><span class="mi">12</span><span class="o">/</span><span class="mi">1</span><span class="o">/</span><span class="mi">10</span> <span class="mi">8</span><span class="p">:</span><span class="mi">26</span><span class="o">|</span>     <span class="mf">2.75</span><span class="o">|</span>     <span class="mi">17850</span><span class="o">|</span><span class="n">United</span> <span class="n">Kingdom</span><span class="o">|</span>
<span class="o">|</span>   <span class="mi">536365</span><span class="o">|</span>   <span class="mi">84029</span><span class="n">G</span><span class="o">|</span><span class="n">KNITTED</span> <span class="n">UNION</span> <span class="n">FLA</span><span class="o">...|</span>       <span class="mi">6</span><span class="o">|</span><span class="mi">12</span><span class="o">/</span><span class="mi">1</span><span class="o">/</span><span class="mi">10</span> <span class="mi">8</span><span class="p">:</span><span class="mi">26</span><span class="o">|</span>     <span class="mf">3.39</span><span class="o">|</span>     <span class="mi">17850</span><span class="o">|</span><span class="n">United</span> <span class="n">Kingdom</span><span class="o">|</span>
<span class="o">|</span>   <span class="mi">536365</span><span class="o">|</span>   <span class="mi">84029</span><span class="n">E</span><span class="o">|</span><span class="n">RED</span> <span class="n">WOOLLY</span> <span class="n">HOTTIE</span><span class="o">...|</span>       <span class="mi">6</span><span class="o">|</span><span class="mi">12</span><span class="o">/</span><span class="mi">1</span><span class="o">/</span><span class="mi">10</span> <span class="mi">8</span><span class="p">:</span><span class="mi">26</span><span class="o">|</span>     <span class="mf">3.39</span><span class="o">|</span>     <span class="mi">17850</span><span class="o">|</span><span class="n">United</span> <span class="n">Kingdom</span><span class="o">|</span>
<span class="o">+---------+---------+--------------------+--------+------------+---------+----------+--------------+</span>
<span class="n">only</span> <span class="n">showing</span> <span class="n">top</span> <span class="mi">5</span> <span class="n">rows</span>

<span class="n">root</span>
 <span class="o">|--</span> <span class="n">InvoiceNo</span><span class="p">:</span> <span class="n">string</span> <span class="p">(</span><span class="n">nullable</span> <span class="o">=</span> <span class="n">true</span><span class="p">)</span>
 <span class="o">|--</span> <span class="n">StockCode</span><span class="p">:</span> <span class="n">string</span> <span class="p">(</span><span class="n">nullable</span> <span class="o">=</span> <span class="n">true</span><span class="p">)</span>
 <span class="o">|--</span> <span class="n">Description</span><span class="p">:</span> <span class="n">string</span> <span class="p">(</span><span class="n">nullable</span> <span class="o">=</span> <span class="n">true</span><span class="p">)</span>
 <span class="o">|--</span> <span class="n">Quantity</span><span class="p">:</span> <span class="n">integer</span> <span class="p">(</span><span class="n">nullable</span> <span class="o">=</span> <span class="n">true</span><span class="p">)</span>
 <span class="o">|--</span> <span class="n">InvoiceDate</span><span class="p">:</span> <span class="n">string</span> <span class="p">(</span><span class="n">nullable</span> <span class="o">=</span> <span class="n">true</span><span class="p">)</span>
 <span class="o">|--</span> <span class="n">UnitPrice</span><span class="p">:</span> <span class="n">double</span> <span class="p">(</span><span class="n">nullable</span> <span class="o">=</span> <span class="n">true</span><span class="p">)</span>
 <span class="o">|--</span> <span class="n">CustomerID</span><span class="p">:</span> <span class="n">integer</span> <span class="p">(</span><span class="n">nullable</span> <span class="o">=</span> <span class="n">true</span><span class="p">)</span>
 <span class="o">|--</span> <span class="n">Country</span><span class="p">:</span> <span class="n">string</span> <span class="p">(</span><span class="n">nullable</span> <span class="o">=</span> <span class="n">true</span><span class="p">)</span>
</pre></div>
</div>
<ol class="arabic simple" start="3">
<li><p>Data clean and data manipulation</p></li>
</ol>
<ul class="simple">
<li><p>check and remove the <code class="docutils literal notranslate"><span class="pre">null</span></code> values</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">count</span>

<span class="k">def</span> <span class="nf">my_count</span><span class="p">(</span><span class="n">df_in</span><span class="p">):</span>
    <span class="n">df_in</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span> <span class="o">*</span><span class="p">[</span> <span class="n">count</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">df_in</span><span class="o">.</span><span class="n">columns</span> <span class="p">]</span> <span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">my_count</span><span class="p">(</span><span class="n">df_raw</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">+---------+---------+-----------+--------+-----------+---------+----------+-------+</span>
<span class="o">|</span><span class="n">InvoiceNo</span><span class="o">|</span><span class="n">StockCode</span><span class="o">|</span><span class="n">Description</span><span class="o">|</span><span class="n">Quantity</span><span class="o">|</span><span class="n">InvoiceDate</span><span class="o">|</span><span class="n">UnitPrice</span><span class="o">|</span><span class="n">CustomerID</span><span class="o">|</span><span class="n">Country</span><span class="o">|</span>
<span class="o">+---------+---------+-----------+--------+-----------+---------+----------+-------+</span>
<span class="o">|</span>   <span class="mi">541909</span><span class="o">|</span>   <span class="mi">541909</span><span class="o">|</span>     <span class="mi">540455</span><span class="o">|</span>  <span class="mi">541909</span><span class="o">|</span>     <span class="mi">541909</span><span class="o">|</span>   <span class="mi">541909</span><span class="o">|</span>    <span class="mi">406829</span><span class="o">|</span> <span class="mi">541909</span><span class="o">|</span>
<span class="o">+---------+---------+-----------+--------+-----------+---------+----------+-------+</span>
</pre></div>
</div>
<p>Since the count results are not the same, we have some null value in the <code class="docutils literal notranslate"><span class="pre">CustomerID</span></code> column. We can drop these records from the dataset.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">df_raw</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">how</span><span class="o">=</span><span class="s1">&#39;any&#39;</span><span class="p">)</span>
<span class="n">my_count</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">+---------+---------+-----------+--------+-----------+---------+----------+-------+</span>
<span class="o">|</span><span class="n">InvoiceNo</span><span class="o">|</span><span class="n">StockCode</span><span class="o">|</span><span class="n">Description</span><span class="o">|</span><span class="n">Quantity</span><span class="o">|</span><span class="n">InvoiceDate</span><span class="o">|</span><span class="n">UnitPrice</span><span class="o">|</span><span class="n">CustomerID</span><span class="o">|</span><span class="n">Country</span><span class="o">|</span>
<span class="o">+---------+---------+-----------+--------+-----------+---------+----------+-------+</span>
<span class="o">|</span>   <span class="mi">406829</span><span class="o">|</span>   <span class="mi">406829</span><span class="o">|</span>     <span class="mi">406829</span><span class="o">|</span>  <span class="mi">406829</span><span class="o">|</span>     <span class="mi">406829</span><span class="o">|</span>   <span class="mi">406829</span><span class="o">|</span>    <span class="mi">406829</span><span class="o">|</span> <span class="mi">406829</span><span class="o">|</span>
<span class="o">+---------+---------+-----------+--------+-----------+---------+----------+-------+</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Dealwith the InvoiceDate</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">to_utc_timestamp</span><span class="p">,</span> <span class="n">unix_timestamp</span><span class="p">,</span> <span class="n">lit</span><span class="p">,</span> <span class="n">datediff</span><span class="p">,</span> <span class="n">col</span>

<span class="n">timeFmt</span> <span class="o">=</span> <span class="s2">&quot;MM/dd/yy HH:mm&quot;</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s1">&#39;NewInvoiceDate&#39;</span>
                 <span class="p">,</span> <span class="n">to_utc_timestamp</span><span class="p">(</span><span class="n">unix_timestamp</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;InvoiceDate&#39;</span><span class="p">),</span><span class="n">timeFmt</span><span class="p">)</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="s1">&#39;timestamp&#39;</span><span class="p">)</span>
                 <span class="p">,</span> <span class="s1">&#39;UTC&#39;</span><span class="p">))</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>

<span class="o">+---------+---------+--------------------+--------+------------+---------+----------+--------------+--------------------+</span>
<span class="o">|</span><span class="n">InvoiceNo</span><span class="o">|</span><span class="n">StockCode</span><span class="o">|</span>         <span class="n">Description</span><span class="o">|</span><span class="n">Quantity</span><span class="o">|</span> <span class="n">InvoiceDate</span><span class="o">|</span><span class="n">UnitPrice</span><span class="o">|</span><span class="n">CustomerID</span><span class="o">|</span>       <span class="n">Country</span><span class="o">|</span>      <span class="n">NewInvoiceDate</span><span class="o">|</span>
<span class="o">+---------+---------+--------------------+--------+------------+---------+----------+--------------+--------------------+</span>
<span class="o">|</span>   <span class="mi">536365</span><span class="o">|</span>   <span class="mi">85123</span><span class="n">A</span><span class="o">|</span><span class="n">WHITE</span> <span class="n">HANGING</span> <span class="n">HEA</span><span class="o">...|</span>       <span class="mi">6</span><span class="o">|</span><span class="mi">12</span><span class="o">/</span><span class="mi">1</span><span class="o">/</span><span class="mi">10</span> <span class="mi">8</span><span class="p">:</span><span class="mi">26</span><span class="o">|</span>     <span class="mf">2.55</span><span class="o">|</span>     <span class="mi">17850</span><span class="o">|</span><span class="n">United</span> <span class="n">Kingdom</span><span class="o">|</span><span class="mi">2010</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">01</span> <span class="mi">08</span><span class="p">:</span><span class="mi">26</span><span class="p">:</span><span class="o">...|</span>
<span class="o">|</span>   <span class="mi">536365</span><span class="o">|</span>    <span class="mi">71053</span><span class="o">|</span> <span class="n">WHITE</span> <span class="n">METAL</span> <span class="n">LANTERN</span><span class="o">|</span>       <span class="mi">6</span><span class="o">|</span><span class="mi">12</span><span class="o">/</span><span class="mi">1</span><span class="o">/</span><span class="mi">10</span> <span class="mi">8</span><span class="p">:</span><span class="mi">26</span><span class="o">|</span>     <span class="mf">3.39</span><span class="o">|</span>     <span class="mi">17850</span><span class="o">|</span><span class="n">United</span> <span class="n">Kingdom</span><span class="o">|</span><span class="mi">2010</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">01</span> <span class="mi">08</span><span class="p">:</span><span class="mi">26</span><span class="p">:</span><span class="o">...|</span>
<span class="o">|</span>   <span class="mi">536365</span><span class="o">|</span>   <span class="mi">84406</span><span class="n">B</span><span class="o">|</span><span class="n">CREAM</span> <span class="n">CUPID</span> <span class="n">HEART</span><span class="o">...|</span>       <span class="mi">8</span><span class="o">|</span><span class="mi">12</span><span class="o">/</span><span class="mi">1</span><span class="o">/</span><span class="mi">10</span> <span class="mi">8</span><span class="p">:</span><span class="mi">26</span><span class="o">|</span>     <span class="mf">2.75</span><span class="o">|</span>     <span class="mi">17850</span><span class="o">|</span><span class="n">United</span> <span class="n">Kingdom</span><span class="o">|</span><span class="mi">2010</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">01</span> <span class="mi">08</span><span class="p">:</span><span class="mi">26</span><span class="p">:</span><span class="o">...|</span>
<span class="o">|</span>   <span class="mi">536365</span><span class="o">|</span>   <span class="mi">84029</span><span class="n">G</span><span class="o">|</span><span class="n">KNITTED</span> <span class="n">UNION</span> <span class="n">FLA</span><span class="o">...|</span>       <span class="mi">6</span><span class="o">|</span><span class="mi">12</span><span class="o">/</span><span class="mi">1</span><span class="o">/</span><span class="mi">10</span> <span class="mi">8</span><span class="p">:</span><span class="mi">26</span><span class="o">|</span>     <span class="mf">3.39</span><span class="o">|</span>     <span class="mi">17850</span><span class="o">|</span><span class="n">United</span> <span class="n">Kingdom</span><span class="o">|</span><span class="mi">2010</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">01</span> <span class="mi">08</span><span class="p">:</span><span class="mi">26</span><span class="p">:</span><span class="o">...|</span>
<span class="o">|</span>   <span class="mi">536365</span><span class="o">|</span>   <span class="mi">84029</span><span class="n">E</span><span class="o">|</span><span class="n">RED</span> <span class="n">WOOLLY</span> <span class="n">HOTTIE</span><span class="o">...|</span>       <span class="mi">6</span><span class="o">|</span><span class="mi">12</span><span class="o">/</span><span class="mi">1</span><span class="o">/</span><span class="mi">10</span> <span class="mi">8</span><span class="p">:</span><span class="mi">26</span><span class="o">|</span>     <span class="mf">3.39</span><span class="o">|</span>     <span class="mi">17850</span><span class="o">|</span><span class="n">United</span> <span class="n">Kingdom</span><span class="o">|</span><span class="mi">2010</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">01</span> <span class="mi">08</span><span class="p">:</span><span class="mi">26</span><span class="p">:</span><span class="o">...|</span>
<span class="o">+---------+---------+--------------------+--------+------------+---------+----------+--------------+--------------------+</span>
<span class="n">only</span> <span class="n">showing</span> <span class="n">top</span> <span class="mi">5</span> <span class="n">rows</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>The spark is pretty sensitive to the date format!</p>
</div>
<ul class="simple">
<li><p>calculate total price</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="nb">round</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s1">&#39;TotalPrice&#39;</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span> <span class="n">df</span><span class="o">.</span><span class="n">Quantity</span> <span class="o">*</span> <span class="n">df</span><span class="o">.</span><span class="n">UnitPrice</span><span class="p">,</span> <span class="mi">2</span> <span class="p">)</span> <span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li><p>calculate the time difference</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">mean</span><span class="p">,</span> <span class="nb">min</span><span class="p">,</span> <span class="nb">max</span><span class="p">,</span> <span class="nb">sum</span><span class="p">,</span> <span class="n">datediff</span><span class="p">,</span> <span class="n">to_date</span>

<span class="n">date_max</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="s1">&#39;NewInvoiceDate&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">toPandas</span><span class="p">()</span>
<span class="n">current</span> <span class="o">=</span> <span class="n">to_utc_timestamp</span><span class="p">(</span> <span class="n">unix_timestamp</span><span class="p">(</span><span class="n">lit</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">date_max</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])),</span> \
                              <span class="s1">&#39;yy-MM-dd HH:mm&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="s1">&#39;timestamp&#39;</span><span class="p">),</span> <span class="s1">&#39;UTC&#39;</span> <span class="p">)</span>

<span class="c1"># Calculatre Duration</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s1">&#39;Duration&#39;</span><span class="p">,</span> <span class="n">datediff</span><span class="p">(</span><span class="n">lit</span><span class="p">(</span><span class="n">current</span><span class="p">),</span> <span class="s1">&#39;NewInvoiceDate&#39;</span><span class="p">))</span>
</pre></div>
</div>
<ul class="simple">
<li><p>build the Recency, Frequency and Monetary</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">recency</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupBy</span><span class="p">(</span><span class="s1">&#39;CustomerID&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="s1">&#39;Duration&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;Recency&#39;</span><span class="p">))</span>
<span class="n">frequency</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupBy</span><span class="p">(</span><span class="s1">&#39;CustomerID&#39;</span><span class="p">,</span> <span class="s1">&#39;InvoiceNo&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>\
                        <span class="o">.</span><span class="n">groupBy</span><span class="p">(</span><span class="s1">&#39;CustomerID&#39;</span><span class="p">)</span>\
                        <span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">count</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;Frequency&quot;</span><span class="p">))</span>
<span class="n">monetary</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupBy</span><span class="p">(</span><span class="s1">&#39;CustomerID&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="s1">&#39;TotalPrice&#39;</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;Monetary&#39;</span><span class="p">))</span>
<span class="n">rfm</span> <span class="o">=</span> <span class="n">recency</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">frequency</span><span class="p">,</span><span class="s1">&#39;CustomerID&#39;</span><span class="p">,</span> <span class="n">how</span> <span class="o">=</span> <span class="s1">&#39;inner&#39;</span><span class="p">)</span>\
             <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">monetary</span><span class="p">,</span><span class="s1">&#39;CustomerID&#39;</span><span class="p">,</span> <span class="n">how</span> <span class="o">=</span> <span class="s1">&#39;inner&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">rfm</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>

<span class="o">+----------+-------+---------+--------+</span>
<span class="o">|</span><span class="n">CustomerID</span><span class="o">|</span><span class="n">Recency</span><span class="o">|</span><span class="n">Frequency</span><span class="o">|</span><span class="n">Monetary</span><span class="o">|</span>
<span class="o">+----------+-------+---------+--------+</span>
<span class="o">|</span>     <span class="mi">17420</span><span class="o">|</span>     <span class="mi">50</span><span class="o">|</span>        <span class="mi">3</span><span class="o">|</span>  <span class="mf">598.83</span><span class="o">|</span>
<span class="o">|</span>     <span class="mi">16861</span><span class="o">|</span>     <span class="mi">59</span><span class="o">|</span>        <span class="mi">3</span><span class="o">|</span>  <span class="mf">151.65</span><span class="o">|</span>
<span class="o">|</span>     <span class="mi">16503</span><span class="o">|</span>    <span class="mi">106</span><span class="o">|</span>        <span class="mi">5</span><span class="o">|</span> <span class="mf">1421.43</span><span class="o">|</span>
<span class="o">|</span>     <span class="mi">15727</span><span class="o">|</span>     <span class="mi">16</span><span class="o">|</span>        <span class="mi">7</span><span class="o">|</span> <span class="mf">5178.96</span><span class="o">|</span>
<span class="o">|</span>     <span class="mi">17389</span><span class="o">|</span>      <span class="mi">0</span><span class="o">|</span>       <span class="mi">43</span><span class="o">|</span><span class="mf">31300.08</span><span class="o">|</span>
<span class="o">+----------+-------+---------+--------+</span>
<span class="n">only</span> <span class="n">showing</span> <span class="n">top</span> <span class="mi">5</span> <span class="n">rows</span>
</pre></div>
</div>
</div>
<div class="section" id="rfm-segmentation">
<h3><span class="section-number">13.2.2. </span>RFM Segmentation<a class="headerlink" href="#rfm-segmentation" title="Permalink to this headline">¶</a></h3>
<ol class="arabic simple" start="4">
<li><p>Determine cutting points</p></li>
</ol>
<p>In this section, you can use the techniques (statistical results and visualizations) in <a class="reference internal" href="exploration.html#exploration"><span class="std std-ref">Data Exploration</span></a> section to help you determine the cutting points for each attribute. In my opinion, the cutting points are mainly depend on the business sense. You’s better talk to your makrting people and get feedback and suggestion from them. I will use the quantile as the cutting points in this demo.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Recency&#39;</span><span class="p">,</span><span class="s1">&#39;Frequency&#39;</span><span class="p">,</span><span class="s1">&#39;Monetary&#39;</span><span class="p">]</span>
<span class="n">describe_pd</span><span class="p">(</span><span class="n">rfm</span><span class="p">,</span><span class="n">cols</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">+-------+-----------------+-----------------+------------------+</span>
<span class="o">|</span><span class="n">summary</span><span class="o">|</span>          <span class="n">Recency</span><span class="o">|</span>        <span class="n">Frequency</span><span class="o">|</span>          <span class="n">Monetary</span><span class="o">|</span>
<span class="o">+-------+-----------------+-----------------+------------------+</span>
<span class="o">|</span>  <span class="n">count</span><span class="o">|</span>           <span class="mf">4372.0</span><span class="o">|</span>           <span class="mf">4372.0</span><span class="o">|</span>            <span class="mf">4372.0</span><span class="o">|</span>
<span class="o">|</span>   <span class="n">mean</span><span class="o">|</span><span class="mf">91.58119853613907</span><span class="o">|</span> <span class="mf">5.07548032936871</span><span class="o">|</span><span class="mf">1898.4597003659655</span><span class="o">|</span>
<span class="o">|</span> <span class="n">stddev</span><span class="o">|</span><span class="mf">100.7721393138483</span><span class="o">|</span><span class="mf">9.338754163574727</span><span class="o">|</span> <span class="mf">8219.345141139722</span><span class="o">|</span>
<span class="o">|</span>    <span class="nb">min</span><span class="o">|</span>              <span class="mf">0.0</span><span class="o">|</span>              <span class="mf">1.0</span><span class="o">|</span>          <span class="o">-</span><span class="mf">4287.63</span><span class="o">|</span>
<span class="o">|</span>    <span class="nb">max</span><span class="o">|</span>            <span class="mf">373.0</span><span class="o">|</span>            <span class="mf">248.0</span><span class="o">|</span>         <span class="mf">279489.02</span><span class="o">|</span>
<span class="o">|</span>    <span class="mi">25</span><span class="o">%|</span>             <span class="mf">16.0</span><span class="o">|</span>              <span class="mf">1.0</span><span class="o">|</span><span class="mf">293.36249999999995</span><span class="o">|</span>
<span class="o">|</span>    <span class="mi">50</span><span class="o">%|</span>             <span class="mf">50.0</span><span class="o">|</span>              <span class="mf">3.0</span><span class="o">|</span>           <span class="mf">648.075</span><span class="o">|</span>
<span class="o">|</span>    <span class="mi">75</span><span class="o">%|</span>            <span class="mf">143.0</span><span class="o">|</span>              <span class="mf">5.0</span><span class="o">|</span>          <span class="mf">1611.725</span><span class="o">|</span>
<span class="o">+-------+-----------------+-----------------+------------------+</span>
</pre></div>
</div>
<p>The user defined function by using the cutting points:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">RScore</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">if</span>  <span class="n">x</span> <span class="o">&lt;=</span> <span class="mi">16</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">1</span>
    <span class="k">elif</span> <span class="n">x</span><span class="o">&lt;=</span> <span class="mi">50</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">2</span>
    <span class="k">elif</span> <span class="n">x</span><span class="o">&lt;=</span> <span class="mi">143</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">3</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">4</span>

<span class="k">def</span> <span class="nf">FScore</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">if</span>  <span class="n">x</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">4</span>
    <span class="k">elif</span> <span class="n">x</span> <span class="o">&lt;=</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">3</span>
    <span class="k">elif</span> <span class="n">x</span> <span class="o">&lt;=</span> <span class="mi">5</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">2</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">1</span>

<span class="k">def</span> <span class="nf">MScore</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">if</span>  <span class="n">x</span> <span class="o">&lt;=</span> <span class="mi">293</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">4</span>
    <span class="k">elif</span> <span class="n">x</span> <span class="o">&lt;=</span> <span class="mi">648</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">3</span>
    <span class="k">elif</span> <span class="n">x</span> <span class="o">&lt;=</span> <span class="mi">1611</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">2</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">1</span>

<span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">udf</span>
<span class="kn">from</span> <span class="nn">pyspark.sql.types</span> <span class="kn">import</span> <span class="n">StringType</span><span class="p">,</span> <span class="n">DoubleType</span>

<span class="n">R_udf</span> <span class="o">=</span> <span class="n">udf</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">RScore</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">StringType</span><span class="p">())</span>
<span class="n">F_udf</span> <span class="o">=</span> <span class="n">udf</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">FScore</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">StringType</span><span class="p">())</span>
<span class="n">M_udf</span> <span class="o">=</span> <span class="n">udf</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">MScore</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">StringType</span><span class="p">())</span>
</pre></div>
</div>
<ol class="arabic simple" start="5">
<li><p>RFM Segmentation</p></li>
</ol>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">rfm_seg</span> <span class="o">=</span> <span class="n">rfm</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;r_seg&quot;</span><span class="p">,</span> <span class="n">R_udf</span><span class="p">(</span><span class="s2">&quot;Recency&quot;</span><span class="p">))</span>
<span class="n">rfm_seg</span> <span class="o">=</span> <span class="n">rfm_seg</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;f_seg&quot;</span><span class="p">,</span> <span class="n">F_udf</span><span class="p">(</span><span class="s2">&quot;Frequency&quot;</span><span class="p">))</span>
<span class="n">rfm_seg</span> <span class="o">=</span> <span class="n">rfm_seg</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;m_seg&quot;</span><span class="p">,</span> <span class="n">M_udf</span><span class="p">(</span><span class="s2">&quot;Monetary&quot;</span><span class="p">))</span>
<span class="n">rfm_seg</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">+----------+-------+---------+--------+-----+-----+-----+</span>
<span class="o">|</span><span class="n">CustomerID</span><span class="o">|</span><span class="n">Recency</span><span class="o">|</span><span class="n">Frequency</span><span class="o">|</span><span class="n">Monetary</span><span class="o">|</span><span class="n">r_seg</span><span class="o">|</span><span class="n">f_seg</span><span class="o">|</span><span class="n">m_seg</span><span class="o">|</span>
<span class="o">+----------+-------+---------+--------+-----+-----+-----+</span>
<span class="o">|</span>     <span class="mi">17420</span><span class="o">|</span>     <span class="mi">50</span><span class="o">|</span>        <span class="mi">3</span><span class="o">|</span>  <span class="mf">598.83</span><span class="o">|</span>    <span class="mi">2</span><span class="o">|</span>    <span class="mi">3</span><span class="o">|</span>    <span class="mi">2</span><span class="o">|</span>
<span class="o">|</span>     <span class="mi">16861</span><span class="o">|</span>     <span class="mi">59</span><span class="o">|</span>        <span class="mi">3</span><span class="o">|</span>  <span class="mf">151.65</span><span class="o">|</span>    <span class="mi">3</span><span class="o">|</span>    <span class="mi">3</span><span class="o">|</span>    <span class="mi">1</span><span class="o">|</span>
<span class="o">|</span>     <span class="mi">16503</span><span class="o">|</span>    <span class="mi">106</span><span class="o">|</span>        <span class="mi">5</span><span class="o">|</span> <span class="mf">1421.43</span><span class="o">|</span>    <span class="mi">3</span><span class="o">|</span>    <span class="mi">2</span><span class="o">|</span>    <span class="mi">3</span><span class="o">|</span>
<span class="o">|</span>     <span class="mi">15727</span><span class="o">|</span>     <span class="mi">16</span><span class="o">|</span>        <span class="mi">7</span><span class="o">|</span> <span class="mf">5178.96</span><span class="o">|</span>    <span class="mi">1</span><span class="o">|</span>    <span class="mi">1</span><span class="o">|</span>    <span class="mi">4</span><span class="o">|</span>
<span class="o">|</span>     <span class="mi">17389</span><span class="o">|</span>      <span class="mi">0</span><span class="o">|</span>       <span class="mi">43</span><span class="o">|</span><span class="mf">31300.08</span><span class="o">|</span>    <span class="mi">1</span><span class="o">|</span>    <span class="mi">1</span><span class="o">|</span>    <span class="mi">4</span><span class="o">|</span>
<span class="o">+----------+-------+---------+--------+-----+-----+-----+</span>
<span class="n">only</span> <span class="n">showing</span> <span class="n">top</span> <span class="mi">5</span> <span class="n">rows</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">rfm_seg</span> <span class="o">=</span> <span class="n">rfm_seg</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s1">&#39;RFMScore&#39;</span><span class="p">,</span>
                             <span class="n">F</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;r_seg&#39;</span><span class="p">),</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;f_seg&#39;</span><span class="p">),</span> <span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;m_seg&#39;</span><span class="p">)))</span>
<span class="n">rfm_seg</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;RFMScore&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">+----------+-------+---------+--------+-----+-----+-----+--------+</span>
<span class="o">|</span><span class="n">CustomerID</span><span class="o">|</span><span class="n">Recency</span><span class="o">|</span><span class="n">Frequency</span><span class="o">|</span><span class="n">Monetary</span><span class="o">|</span><span class="n">r_seg</span><span class="o">|</span><span class="n">f_seg</span><span class="o">|</span><span class="n">m_seg</span><span class="o">|</span><span class="n">RFMScore</span><span class="o">|</span>
<span class="o">+----------+-------+---------+--------+-----+-----+-----+--------+</span>
<span class="o">|</span>     <span class="mi">17988</span><span class="o">|</span>     <span class="mi">11</span><span class="o">|</span>        <span class="mi">8</span><span class="o">|</span>  <span class="mf">191.17</span><span class="o">|</span>    <span class="mi">1</span><span class="o">|</span>    <span class="mi">1</span><span class="o">|</span>    <span class="mi">1</span><span class="o">|</span>     <span class="mi">111</span><span class="o">|</span>
<span class="o">|</span>     <span class="mi">16892</span><span class="o">|</span>      <span class="mi">1</span><span class="o">|</span>        <span class="mi">7</span><span class="o">|</span>  <span class="mf">496.84</span><span class="o">|</span>    <span class="mi">1</span><span class="o">|</span>    <span class="mi">1</span><span class="o">|</span>    <span class="mi">2</span><span class="o">|</span>     <span class="mi">112</span><span class="o">|</span>
<span class="o">|</span>     <span class="mi">16668</span><span class="o">|</span>     <span class="mi">15</span><span class="o">|</span>        <span class="mi">6</span><span class="o">|</span>  <span class="mf">306.72</span><span class="o">|</span>    <span class="mi">1</span><span class="o">|</span>    <span class="mi">1</span><span class="o">|</span>    <span class="mi">2</span><span class="o">|</span>     <span class="mi">112</span><span class="o">|</span>
<span class="o">|</span>     <span class="mi">16554</span><span class="o">|</span>      <span class="mi">3</span><span class="o">|</span>        <span class="mi">7</span><span class="o">|</span>  <span class="mf">641.55</span><span class="o">|</span>    <span class="mi">1</span><span class="o">|</span>    <span class="mi">1</span><span class="o">|</span>    <span class="mi">2</span><span class="o">|</span>     <span class="mi">112</span><span class="o">|</span>
<span class="o">|</span>     <span class="mi">16500</span><span class="o">|</span>      <span class="mi">4</span><span class="o">|</span>        <span class="mi">6</span><span class="o">|</span>  <span class="mf">400.86</span><span class="o">|</span>    <span class="mi">1</span><span class="o">|</span>    <span class="mi">1</span><span class="o">|</span>    <span class="mi">2</span><span class="o">|</span>     <span class="mi">112</span><span class="o">|</span>
<span class="o">+----------+-------+---------+--------+-----+-----+-----+--------+</span>
<span class="n">only</span> <span class="n">showing</span> <span class="n">top</span> <span class="mi">5</span> <span class="n">rows</span>
</pre></div>
</div>
</div>
<div class="section" id="statistical-summary">
<h3><span class="section-number">13.2.3. </span>Statistical Summary<a class="headerlink" href="#statistical-summary" title="Permalink to this headline">¶</a></h3>
<ol class="arabic simple" start="6">
<li><p>Statistical Summary</p></li>
</ol>
<ul class="simple">
<li><p>simple summary</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">rfm_seg</span><span class="o">.</span><span class="n">groupBy</span><span class="p">(</span><span class="s1">&#39;RFMScore&#39;</span><span class="p">)</span>\
       <span class="o">.</span><span class="n">agg</span><span class="p">({</span><span class="s1">&#39;Recency&#39;</span><span class="p">:</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span>
             <span class="s1">&#39;Frequency&#39;</span><span class="p">:</span> <span class="s1">&#39;mean&#39;</span><span class="p">,</span>
             <span class="s1">&#39;Monetary&#39;</span><span class="p">:</span> <span class="s1">&#39;mean&#39;</span><span class="p">}</span> <span class="p">)</span>\
        <span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;RFMScore&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">+--------+-----------------+------------------+------------------+</span>
<span class="o">|</span><span class="n">RFMScore</span><span class="o">|</span>     <span class="n">avg</span><span class="p">(</span><span class="n">Recency</span><span class="p">)</span><span class="o">|</span>     <span class="n">avg</span><span class="p">(</span><span class="n">Monetary</span><span class="p">)</span><span class="o">|</span>    <span class="n">avg</span><span class="p">(</span><span class="n">Frequency</span><span class="p">)</span><span class="o">|</span>
<span class="o">+--------+-----------------+------------------+------------------+</span>
<span class="o">|</span>     <span class="mi">111</span><span class="o">|</span>             <span class="mf">11.0</span><span class="o">|</span>            <span class="mf">191.17</span><span class="o">|</span>               <span class="mf">8.0</span><span class="o">|</span>
<span class="o">|</span>     <span class="mi">112</span><span class="o">|</span>              <span class="mf">8.0</span><span class="o">|</span>          <span class="mf">505.9775</span><span class="o">|</span>               <span class="mf">7.5</span><span class="o">|</span>
<span class="o">|</span>     <span class="mi">113</span><span class="o">|</span><span class="mf">7.237113402061856</span><span class="o">|</span><span class="mf">1223.3604123711339</span><span class="o">|</span> <span class="mf">7.752577319587629</span><span class="o">|</span>
<span class="o">|</span>     <span class="mi">114</span><span class="o">|</span><span class="mf">6.035123966942149</span><span class="o">|</span> <span class="mf">8828.888595041324</span><span class="o">|</span><span class="mf">18.882231404958677</span><span class="o">|</span>
<span class="o">|</span>     <span class="mi">121</span><span class="o">|</span>              <span class="mf">9.6</span><span class="o">|</span>            <span class="mf">207.24</span><span class="o">|</span>               <span class="mf">4.4</span><span class="o">|</span>
<span class="o">+--------+-----------------+------------------+------------------+</span>
<span class="n">only</span> <span class="n">showing</span> <span class="n">top</span> <span class="mi">5</span> <span class="n">rows</span>
</pre></div>
</div>
<ul class="simple">
<li><p>complex summary</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">grp</span> <span class="o">=</span> <span class="s1">&#39;RFMScore&#39;</span>
<span class="n">num_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Recency&#39;</span><span class="p">,</span><span class="s1">&#39;Frequency&#39;</span><span class="p">,</span><span class="s1">&#39;Monetary&#39;</span><span class="p">]</span>
<span class="n">df_input</span> <span class="o">=</span> <span class="n">rfm_seg</span>

<span class="n">quantile_grouped</span> <span class="o">=</span> <span class="n">quantile_agg</span><span class="p">(</span><span class="n">df_input</span><span class="p">,</span><span class="n">grp</span><span class="p">,</span><span class="n">num_cols</span><span class="p">)</span>
<span class="n">quantile_grouped</span><span class="o">.</span><span class="n">toPandas</span><span class="p">()</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">output_dir</span><span class="o">+</span><span class="s1">&#39;quantile_grouped.csv&#39;</span><span class="p">)</span>

<span class="n">deciles_grouped</span> <span class="o">=</span> <span class="n">deciles_agg</span><span class="p">(</span><span class="n">df_input</span><span class="p">,</span><span class="n">grp</span><span class="p">,</span><span class="n">num_cols</span><span class="p">)</span>
<span class="n">deciles_grouped</span><span class="o">.</span><span class="n">toPandas</span><span class="p">()</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">output_dir</span><span class="o">+</span><span class="s1">&#39;deciles_grouped.csv&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="extension">
<h2><span class="section-number">13.3. </span>Extension<a class="headerlink" href="#extension" title="Permalink to this headline">¶</a></h2>
<p>You can also apply the K-means clustering in <a class="reference internal" href="clustering.html#clustering"><span class="std std-ref">Clustering</span></a> section to do the segmentation.</p>
<div class="section" id="build-feature-matrix">
<h3><span class="section-number">13.3.1. </span>Build feature matrix<a class="headerlink" href="#build-feature-matrix" title="Permalink to this headline">¶</a></h3>
<ol class="arabic simple">
<li><p>build dense feature matrix</p></li>
</ol>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyspark.sql</span> <span class="kn">import</span> <span class="n">Row</span>
<span class="kn">from</span> <span class="nn">pyspark.ml.linalg</span> <span class="kn">import</span> <span class="n">Vectors</span>

<span class="c1"># method 1 (good for small feature):</span>
<span class="c1">#def transData(row):</span>
<span class="c1">#    return Row(label=row[&quot;Sales&quot;],</span>
<span class="c1">#               features=Vectors.dense([row[&quot;TV&quot;],</span>
<span class="c1">#                                       row[&quot;Radio&quot;],</span>
<span class="c1">#                                       row[&quot;Newspaper&quot;]]))</span>

<span class="c1"># Method 2 (good for large features):</span>
<span class="k">def</span> <span class="nf">transData</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">data</span><span class="o">.</span><span class="n">rdd</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">Vectors</span><span class="o">.</span><span class="n">dense</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">:])])</span><span class="o">.</span><span class="n">toDF</span><span class="p">([</span><span class="s1">&#39;CustomerID&#39;</span><span class="p">,</span><span class="s1">&#39;rfm&#39;</span><span class="p">])</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">transformed</span><span class="o">=</span> <span class="n">transData</span><span class="p">(</span><span class="n">rfm</span><span class="p">)</span>
<span class="n">transformed</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">+----------+-------------------+</span>
<span class="o">|</span><span class="n">CustomerID</span><span class="o">|</span>                <span class="n">rfm</span><span class="o">|</span>
<span class="o">+----------+-------------------+</span>
<span class="o">|</span>     <span class="mi">17420</span><span class="o">|</span>  <span class="p">[</span><span class="mf">50.0</span><span class="p">,</span><span class="mf">3.0</span><span class="p">,</span><span class="mf">598.83</span><span class="p">]</span><span class="o">|</span>
<span class="o">|</span>     <span class="mi">16861</span><span class="o">|</span>  <span class="p">[</span><span class="mf">59.0</span><span class="p">,</span><span class="mf">3.0</span><span class="p">,</span><span class="mf">151.65</span><span class="p">]</span><span class="o">|</span>
<span class="o">|</span>     <span class="mi">16503</span><span class="o">|</span><span class="p">[</span><span class="mf">106.0</span><span class="p">,</span><span class="mf">5.0</span><span class="p">,</span><span class="mf">1421.43</span><span class="p">]</span><span class="o">|</span>
<span class="o">|</span>     <span class="mi">15727</span><span class="o">|</span> <span class="p">[</span><span class="mf">16.0</span><span class="p">,</span><span class="mf">7.0</span><span class="p">,</span><span class="mf">5178.96</span><span class="p">]</span><span class="o">|</span>
<span class="o">|</span>     <span class="mi">17389</span><span class="o">|</span><span class="p">[</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">43.0</span><span class="p">,</span><span class="mf">31300.08</span><span class="p">]</span><span class="o">|</span>
<span class="o">+----------+-------------------+</span>
<span class="n">only</span> <span class="n">showing</span> <span class="n">top</span> <span class="mi">5</span> <span class="n">rows</span>
</pre></div>
</div>
<ol class="arabic simple" start="2">
<li><p>Scaler the feature matrix</p></li>
</ol>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyspark.ml.feature</span> <span class="kn">import</span> <span class="n">MinMaxScaler</span>

<span class="n">scaler</span> <span class="o">=</span> <span class="n">MinMaxScaler</span><span class="p">(</span><span class="n">inputCol</span><span class="o">=</span><span class="s2">&quot;rfm&quot;</span><span class="p">,</span>\
         <span class="n">outputCol</span><span class="o">=</span><span class="s2">&quot;features&quot;</span><span class="p">)</span>
<span class="n">scalerModel</span> <span class="o">=</span>  <span class="n">scaler</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">transformed</span><span class="p">)</span>
<span class="n">scaledData</span> <span class="o">=</span> <span class="n">scalerModel</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">transformed</span><span class="p">)</span>
<span class="n">scaledData</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">+----------+-------------------+--------------------------------------------------------------+</span>
<span class="o">|</span><span class="n">CustomerID</span><span class="o">|</span><span class="n">rfm</span>                <span class="o">|</span><span class="n">features</span>                                                      <span class="o">|</span>
<span class="o">+----------+-------------------+--------------------------------------------------------------+</span>
<span class="o">|</span><span class="mi">17420</span>     <span class="o">|</span><span class="p">[</span><span class="mf">50.0</span><span class="p">,</span><span class="mf">3.0</span><span class="p">,</span><span class="mf">598.83</span><span class="p">]</span>  <span class="o">|</span><span class="p">[</span><span class="mf">0.13404825737265416</span><span class="p">,</span><span class="mf">0.008097165991902834</span><span class="p">,</span><span class="mf">0.01721938714830836</span><span class="p">]</span><span class="o">|</span>
<span class="o">|</span><span class="mi">16861</span>     <span class="o">|</span><span class="p">[</span><span class="mf">59.0</span><span class="p">,</span><span class="mf">3.0</span><span class="p">,</span><span class="mf">151.65</span><span class="p">]</span>  <span class="o">|</span><span class="p">[</span><span class="mf">0.1581769436997319</span><span class="p">,</span><span class="mf">0.008097165991902834</span><span class="p">,</span><span class="mf">0.01564357039241953</span><span class="p">]</span> <span class="o">|</span>
<span class="o">|</span><span class="mi">16503</span>     <span class="o">|</span><span class="p">[</span><span class="mf">106.0</span><span class="p">,</span><span class="mf">5.0</span><span class="p">,</span><span class="mf">1421.43</span><span class="p">]</span><span class="o">|</span><span class="p">[</span><span class="mf">0.28418230563002683</span><span class="p">,</span><span class="mf">0.016194331983805668</span><span class="p">,</span><span class="mf">0.02011814573186342</span><span class="p">]</span><span class="o">|</span>
<span class="o">|</span><span class="mi">15727</span>     <span class="o">|</span><span class="p">[</span><span class="mf">16.0</span><span class="p">,</span><span class="mf">7.0</span><span class="p">,</span><span class="mf">5178.96</span><span class="p">]</span> <span class="o">|</span><span class="p">[</span><span class="mf">0.04289544235924933</span><span class="p">,</span><span class="mf">0.024291497975708502</span><span class="p">,</span><span class="mf">0.03335929858922501</span><span class="p">]</span><span class="o">|</span>
<span class="o">|</span><span class="mi">17389</span>     <span class="o">|</span><span class="p">[</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">43.0</span><span class="p">,</span><span class="mf">31300.08</span><span class="p">]</span><span class="o">|</span><span class="p">[</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.1700404858299595</span><span class="p">,</span><span class="mf">0.12540746393334334</span><span class="p">]</span>                  <span class="o">|</span>
<span class="o">+----------+-------------------+--------------------------------------------------------------+</span>
<span class="n">only</span> <span class="n">showing</span> <span class="n">top</span> <span class="mi">5</span> <span class="n">rows</span>
</pre></div>
</div>
</div>
<div class="section" id="k-means-clustering">
<h3><span class="section-number">13.3.2. </span>K-means clustering<a class="headerlink" href="#k-means-clustering" title="Permalink to this headline">¶</a></h3>
<ol class="arabic simple" start="3">
<li><p>Find optimal number of cluster</p></li>
</ol>
<p>I will present two popular ways to determine the optimal number of the cluster.</p>
<ul class="simple">
<li><p>elbow analysis</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#PySpark libraries</span>
<span class="kn">from</span> <span class="nn">pyspark.ml</span> <span class="kn">import</span> <span class="n">Pipeline</span>
<span class="kn">from</span> <span class="nn">pyspark.ml.feature</span> <span class="kn">import</span> <span class="n">StringIndexer</span><span class="p">,</span> <span class="n">OneHotEncoder</span><span class="p">,</span> <span class="n">VectorAssembler</span>
<span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">col</span><span class="p">,</span> <span class="n">percent_rank</span><span class="p">,</span> <span class="n">lit</span>
<span class="kn">from</span> <span class="nn">pyspark.sql.window</span> <span class="kn">import</span> <span class="n">Window</span>
<span class="kn">from</span> <span class="nn">pyspark.sql</span> <span class="kn">import</span> <span class="n">DataFrame</span><span class="p">,</span> <span class="n">Row</span>
<span class="kn">from</span> <span class="nn">pyspark.sql.types</span> <span class="kn">import</span> <span class="n">StructType</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">reduce</span>  <span class="c1"># For Python 3.x</span>

<span class="kn">from</span> <span class="nn">pyspark.ml.clustering</span> <span class="kn">import</span> <span class="n">KMeans</span>
<span class="c1">#from pyspark.ml.evaluation import ClusteringEvaluator  # requires Spark 2.4 or later</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="n">cost</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">20</span><span class="p">):</span>
    <span class="n">kmeans</span> <span class="o">=</span> <span class="n">KMeans</span><span class="p">()</span>\
            <span class="o">.</span><span class="n">setK</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>\
            <span class="o">.</span><span class="n">setSeed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> \
            <span class="o">.</span><span class="n">setFeaturesCol</span><span class="p">(</span><span class="s2">&quot;features&quot;</span><span class="p">)</span>\
            <span class="o">.</span><span class="n">setPredictionCol</span><span class="p">(</span><span class="s2">&quot;cluster&quot;</span><span class="p">)</span>

    <span class="n">model</span> <span class="o">=</span> <span class="n">kmeans</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">scaledData</span><span class="p">)</span>
    <span class="n">cost</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">computeCost</span><span class="p">(</span><span class="n">scaledData</span><span class="p">)</span> <span class="c1"># requires Spark 2.0 or later</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.mlab</span> <span class="k">as</span> <span class="nn">mlab</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sbs</span>
<span class="kn">from</span> <span class="nn">matplotlib.ticker</span> <span class="kn">import</span> <span class="n">MaxNLocator</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span> <span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">20</span><span class="p">),</span><span class="n">cost</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">20</span><span class="p">],</span> <span class="n">marker</span> <span class="o">=</span> <span class="s2">&quot;o&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;cost&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">MaxNLocator</span><span class="p">(</span><span class="n">integer</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<div class="figure align-center" id="id3">
<span id="fig-elbow-rfm"></span><img alt="_images/elbow_rfm.png" src="_images/elbow_rfm.png" />
<p class="caption"><span class="caption-text">Cost v.s. the number of the clusters</span><a class="headerlink" href="#id3" title="Permalink to this image">¶</a></p>
</div>
<p>In my opinion, sometimes it’s hard to choose the number of the clusters. As shown in Figure <a class="reference internal" href="#fig-elbow-rfm"><span class="std std-ref">Cost v.s. the number of the clusters</span></a>, you can choose 3, 5 or even 8. I will choose <code class="docutils literal notranslate"><span class="pre">3</span></code> in this demo.</p>
<ul class="simple">
<li><p>Silhouette analysis</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#PySpark libraries</span>
<span class="kn">from</span> <span class="nn">pyspark.ml</span> <span class="kn">import</span> <span class="n">Pipeline</span>
<span class="kn">from</span> <span class="nn">pyspark.ml.feature</span> <span class="kn">import</span> <span class="n">StringIndexer</span><span class="p">,</span> <span class="n">OneHotEncoder</span><span class="p">,</span> <span class="n">VectorAssembler</span>
<span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">col</span><span class="p">,</span> <span class="n">percent_rank</span><span class="p">,</span> <span class="n">lit</span>
<span class="kn">from</span> <span class="nn">pyspark.sql.window</span> <span class="kn">import</span> <span class="n">Window</span>
<span class="kn">from</span> <span class="nn">pyspark.sql</span> <span class="kn">import</span> <span class="n">DataFrame</span><span class="p">,</span> <span class="n">Row</span>
<span class="kn">from</span> <span class="nn">pyspark.sql.types</span> <span class="kn">import</span> <span class="n">StructType</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">reduce</span>  <span class="c1"># For Python 3.x</span>

<span class="kn">from</span> <span class="nn">pyspark.ml.clustering</span> <span class="kn">import</span> <span class="n">KMeans</span>
<span class="kn">from</span> <span class="nn">pyspark.ml.evaluation</span> <span class="kn">import</span> <span class="n">ClusteringEvaluator</span>

<span class="k">def</span> <span class="nf">optimal_k</span><span class="p">(</span><span class="n">df_in</span><span class="p">,</span><span class="n">index_col</span><span class="p">,</span><span class="n">k_min</span><span class="p">,</span> <span class="n">k_max</span><span class="p">,</span><span class="n">num_runs</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Determine optimal number of clusters by using Silhoutte Score Analysis.</span>
<span class="sd">    :param df_in: the input dataframe</span>
<span class="sd">    :param index_col: the name of the index column</span>
<span class="sd">    :param k_min: the train dataset</span>
<span class="sd">    :param k_min: the minmum number of the clusters</span>
<span class="sd">    :param k_max: the maxmum number of the clusters</span>
<span class="sd">    :param num_runs: the number of runs for each fixed clusters</span>

<span class="sd">    :return k: optimal number of the clusters</span>
<span class="sd">    :return silh_lst: Silhouette score</span>
<span class="sd">    :return r_table: the running results table</span>

<span class="sd">    :author: Wenqiang Feng</span>
<span class="sd">    :email:  von198@gmail.com.com</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">silh_lst</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">k_lst</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">k_min</span><span class="p">,</span> <span class="n">k_max</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">r_table</span> <span class="o">=</span> <span class="n">df_in</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">index_col</span><span class="p">)</span><span class="o">.</span><span class="n">toPandas</span><span class="p">()</span>
    <span class="n">r_table</span> <span class="o">=</span> <span class="n">r_table</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">index_col</span><span class="p">)</span>
    <span class="n">centers</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">k_lst</span><span class="p">:</span>
        <span class="n">silh_val</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">run</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_runs</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>

            <span class="c1"># Trains a k-means model.</span>
            <span class="n">kmeans</span> <span class="o">=</span> <span class="n">KMeans</span><span class="p">()</span>\
                    <span class="o">.</span><span class="n">setK</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>\
                    <span class="o">.</span><span class="n">setSeed</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">1</span><span class="p">)))</span>
            <span class="n">model</span> <span class="o">=</span> <span class="n">kmeans</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">df_in</span><span class="p">)</span>

            <span class="c1"># Make predictions</span>
            <span class="n">predictions</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">df_in</span><span class="p">)</span>
            <span class="n">r_table</span><span class="p">[</span><span class="s1">&#39;cluster_</span><span class="si">{k}</span><span class="s1">_</span><span class="si">{run}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="n">run</span><span class="o">=</span><span class="n">run</span><span class="p">)]</span><span class="o">=</span> <span class="n">predictions</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s1">&#39;prediction&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">toPandas</span><span class="p">()</span>

            <span class="c1"># Evaluate clustering by computing Silhouette score</span>
            <span class="n">evaluator</span> <span class="o">=</span> <span class="n">ClusteringEvaluator</span><span class="p">()</span>
            <span class="n">silhouette</span> <span class="o">=</span> <span class="n">evaluator</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">predictions</span><span class="p">)</span>
            <span class="n">silh_val</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">silhouette</span><span class="p">)</span>

        <span class="n">silh_array</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">asanyarray</span><span class="p">(</span><span class="n">silh_val</span><span class="p">)</span>
        <span class="n">silh_lst</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">silh_array</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>

    <span class="n">elapsed</span> <span class="o">=</span>  <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>

    <span class="n">silhouette</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">k_lst</span><span class="p">,</span><span class="n">silh_lst</span><span class="p">)),</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="s1">&#39;silhouette&#39;</span><span class="p">])</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;+------------------------------------------------------------+&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;|         The finding optimal k phase took </span><span class="si">%8.0f</span><span class="s2"> s.       |&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">elapsed</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;+------------------------------------------------------------+&#39;</span><span class="p">)</span>


    <span class="k">return</span> <span class="n">k_lst</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">silh_lst</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)],</span> <span class="n">silhouette</span> <span class="p">,</span> <span class="n">r_table</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">k</span><span class="p">,</span> <span class="n">silh_lst</span><span class="p">,</span> <span class="n">r_table</span> <span class="o">=</span> <span class="n">optimal_k</span><span class="p">(</span><span class="n">scaledData</span><span class="p">,</span><span class="n">index_col</span><span class="p">,</span><span class="n">k_min</span><span class="p">,</span> <span class="n">k_max</span><span class="p">,</span><span class="n">num_runs</span><span class="p">)</span>

<span class="o">+------------------------------------------------------------+</span>
<span class="o">|</span>         <span class="n">The</span> <span class="n">finding</span> <span class="n">optimal</span> <span class="n">k</span> <span class="n">phase</span> <span class="n">took</span>     <span class="mi">1783</span> <span class="n">s</span><span class="o">.</span>       <span class="o">|</span>
<span class="o">+------------------------------------------------------------+</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">spark</span><span class="o">.</span><span class="n">createDataFrame</span><span class="p">(</span><span class="n">silh_lst</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="o">+---+------------------+</span>
<span class="o">|</span>  <span class="n">k</span><span class="o">|</span>        <span class="n">silhouette</span><span class="o">|</span>
<span class="o">+---+------------------+</span>
<span class="o">|</span>  <span class="mi">3</span><span class="o">|</span><span class="mf">0.8045154385557953</span><span class="o">|</span>
<span class="o">|</span>  <span class="mi">4</span><span class="o">|</span><span class="mf">0.6993528775512052</span><span class="o">|</span>
<span class="o">|</span>  <span class="mi">5</span><span class="o">|</span><span class="mf">0.6689286654221447</span><span class="o">|</span>
<span class="o">|</span>  <span class="mi">6</span><span class="o">|</span><span class="mf">0.6356184024841809</span><span class="o">|</span>
<span class="o">|</span>  <span class="mi">7</span><span class="o">|</span><span class="mf">0.7174102265711756</span><span class="o">|</span>
<span class="o">|</span>  <span class="mi">8</span><span class="o">|</span><span class="mf">0.6720861758298997</span><span class="o">|</span>
<span class="o">|</span>  <span class="mi">9</span><span class="o">|</span> <span class="mf">0.601771359881241</span><span class="o">|</span>
<span class="o">|</span> <span class="mi">10</span><span class="o">|</span><span class="mf">0.6292447334578428</span><span class="o">|</span>
<span class="o">+---+------------------+</span>
</pre></div>
</div>
<p>From the silhouette list, we can choose <code class="docutils literal notranslate"><span class="pre">3</span></code> as the optimal number of the clusters.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p><code class="docutils literal notranslate"><span class="pre">ClusteringEvaluator</span></code> in <code class="docutils literal notranslate"><span class="pre">pyspark.ml.evaluation</span></code> requires Spark 2.4 or later!!</p>
</div>
<ol class="arabic simple" start="4">
<li><p>K-means clustering</p></li>
</ol>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">k</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">kmeans</span> <span class="o">=</span> <span class="n">KMeans</span><span class="p">()</span><span class="o">.</span><span class="n">setK</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">.</span><span class="n">setSeed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">kmeans</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">scaledData</span><span class="p">)</span>
<span class="c1"># Make predictions</span>
<span class="n">predictions</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">scaledData</span><span class="p">)</span>
<span class="n">predictions</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">+----------+-------------------+--------------------+----------+</span>
<span class="o">|</span><span class="n">CustomerID</span><span class="o">|</span>                <span class="n">rfm</span><span class="o">|</span>            <span class="n">features</span><span class="o">|</span><span class="n">prediction</span><span class="o">|</span>
<span class="o">+----------+-------------------+--------------------+----------+</span>
<span class="o">|</span>     <span class="mi">17420</span><span class="o">|</span>  <span class="p">[</span><span class="mf">50.0</span><span class="p">,</span><span class="mf">3.0</span><span class="p">,</span><span class="mf">598.83</span><span class="p">]</span><span class="o">|</span><span class="p">[</span><span class="mf">0.13404825737265</span><span class="o">...|</span>         <span class="mi">0</span><span class="o">|</span>
<span class="o">|</span>     <span class="mi">16861</span><span class="o">|</span>  <span class="p">[</span><span class="mf">59.0</span><span class="p">,</span><span class="mf">3.0</span><span class="p">,</span><span class="mf">151.65</span><span class="p">]</span><span class="o">|</span><span class="p">[</span><span class="mf">0.15817694369973</span><span class="o">...|</span>         <span class="mi">0</span><span class="o">|</span>
<span class="o">|</span>     <span class="mi">16503</span><span class="o">|</span><span class="p">[</span><span class="mf">106.0</span><span class="p">,</span><span class="mf">5.0</span><span class="p">,</span><span class="mf">1421.43</span><span class="p">]</span><span class="o">|</span><span class="p">[</span><span class="mf">0.28418230563002</span><span class="o">...|</span>         <span class="mi">2</span><span class="o">|</span>
<span class="o">|</span>     <span class="mi">15727</span><span class="o">|</span> <span class="p">[</span><span class="mf">16.0</span><span class="p">,</span><span class="mf">7.0</span><span class="p">,</span><span class="mf">5178.96</span><span class="p">]</span><span class="o">|</span><span class="p">[</span><span class="mf">0.04289544235924</span><span class="o">...|</span>         <span class="mi">0</span><span class="o">|</span>
<span class="o">|</span>     <span class="mi">17389</span><span class="o">|</span><span class="p">[</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">43.0</span><span class="p">,</span><span class="mf">31300.08</span><span class="p">]</span><span class="o">|</span><span class="p">[</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.1700404858</span><span class="o">...|</span>         <span class="mi">0</span><span class="o">|</span>
<span class="o">+----------+-------------------+--------------------+----------+</span>
<span class="n">only</span> <span class="n">showing</span> <span class="n">top</span> <span class="mi">5</span> <span class="n">rows</span>
</pre></div>
</div>
</div>
<div class="section" id="id1">
<h3><span class="section-number">13.3.3. </span>Statistical summary<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<ol class="arabic simple" start="5">
<li><p>statistical summary</p></li>
</ol>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">results</span> <span class="o">=</span> <span class="n">rfm</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">predictions</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s1">&#39;CustomerID&#39;</span><span class="p">,</span><span class="s1">&#39;prediction&#39;</span><span class="p">),</span><span class="s1">&#39;CustomerID&#39;</span><span class="p">,</span><span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
<span class="n">results</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">+----------+-------+---------+--------+----------+</span>
<span class="o">|</span><span class="n">CustomerID</span><span class="o">|</span><span class="n">Recency</span><span class="o">|</span><span class="n">Frequency</span><span class="o">|</span><span class="n">Monetary</span><span class="o">|</span><span class="n">prediction</span><span class="o">|</span>
<span class="o">+----------+-------+---------+--------+----------+</span>
<span class="o">|</span>     <span class="mi">13098</span><span class="o">|</span>      <span class="mi">1</span><span class="o">|</span>       <span class="mi">41</span><span class="o">|</span><span class="mf">28658.88</span><span class="o">|</span>         <span class="mi">0</span><span class="o">|</span>
<span class="o">|</span>     <span class="mi">13248</span><span class="o">|</span>    <span class="mi">124</span><span class="o">|</span>        <span class="mi">2</span><span class="o">|</span>  <span class="mf">465.68</span><span class="o">|</span>         <span class="mi">2</span><span class="o">|</span>
<span class="o">|</span>     <span class="mi">13452</span><span class="o">|</span>    <span class="mi">259</span><span class="o">|</span>        <span class="mi">2</span><span class="o">|</span>   <span class="mf">590.0</span><span class="o">|</span>         <span class="mi">1</span><span class="o">|</span>
<span class="o">|</span>     <span class="mi">13460</span><span class="o">|</span>     <span class="mi">29</span><span class="o">|</span>        <span class="mi">2</span><span class="o">|</span>  <span class="mf">183.44</span><span class="o">|</span>         <span class="mi">0</span><span class="o">|</span>
<span class="o">|</span>     <span class="mi">13518</span><span class="o">|</span>     <span class="mi">85</span><span class="o">|</span>        <span class="mi">1</span><span class="o">|</span>  <span class="mf">659.44</span><span class="o">|</span>         <span class="mi">0</span><span class="o">|</span>
<span class="o">+----------+-------+---------+--------+----------+</span>
<span class="n">only</span> <span class="n">showing</span> <span class="n">top</span> <span class="mi">5</span> <span class="n">rows</span>
</pre></div>
</div>
<ul class="simple">
<li><p>simple summary</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">results</span><span class="o">.</span><span class="n">groupBy</span><span class="p">(</span><span class="s1">&#39;prediction&#39;</span><span class="p">)</span>\
       <span class="o">.</span><span class="n">agg</span><span class="p">({</span><span class="s1">&#39;Recency&#39;</span><span class="p">:</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span>
             <span class="s1">&#39;Frequency&#39;</span><span class="p">:</span> <span class="s1">&#39;mean&#39;</span><span class="p">,</span>
             <span class="s1">&#39;Monetary&#39;</span><span class="p">:</span> <span class="s1">&#39;mean&#39;</span><span class="p">}</span> <span class="p">)</span>\
        <span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;prediction&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">+----------+------------------+------------------+------------------+</span>
<span class="o">|</span><span class="n">prediction</span><span class="o">|</span>      <span class="n">avg</span><span class="p">(</span><span class="n">Recency</span><span class="p">)</span><span class="o">|</span>     <span class="n">avg</span><span class="p">(</span><span class="n">Monetary</span><span class="p">)</span><span class="o">|</span>    <span class="n">avg</span><span class="p">(</span><span class="n">Frequency</span><span class="p">)</span><span class="o">|</span>
<span class="o">+----------+------------------+------------------+------------------+</span>
<span class="o">|</span>         <span class="mi">0</span><span class="o">|</span><span class="mf">30.966337980278816</span><span class="o">|</span><span class="mf">2543.0355321319284</span><span class="o">|</span> <span class="mf">6.514450867052023</span><span class="o">|</span>
<span class="o">|</span>         <span class="mi">1</span><span class="o">|</span><span class="mf">296.02403846153845</span><span class="o">|</span><span class="mf">407.16831730769206</span><span class="o">|</span><span class="mf">1.5592948717948718</span><span class="o">|</span>
<span class="o">|</span>         <span class="mi">2</span><span class="o">|</span><span class="mf">154.40148698884758</span><span class="o">|</span> <span class="mf">702.5096406443623</span><span class="o">|</span> <span class="mf">2.550185873605948</span><span class="o">|</span>
<span class="o">+----------+------------------+------------------+------------------+</span>
</pre></div>
</div>
<ul class="simple">
<li><p>complex summary</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">grp</span> <span class="o">=</span> <span class="s1">&#39;RFMScore&#39;</span>
<span class="n">num_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Recency&#39;</span><span class="p">,</span><span class="s1">&#39;Frequency&#39;</span><span class="p">,</span><span class="s1">&#39;Monetary&#39;</span><span class="p">]</span>
<span class="n">df_input</span> <span class="o">=</span> <span class="n">results</span>

<span class="n">quantile_grouped</span> <span class="o">=</span> <span class="n">quantile_agg</span><span class="p">(</span><span class="n">df_input</span><span class="p">,</span><span class="n">grp</span><span class="p">,</span><span class="n">num_cols</span><span class="p">)</span>
<span class="n">quantile_grouped</span><span class="o">.</span><span class="n">toPandas</span><span class="p">()</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">output_dir</span><span class="o">+</span><span class="s1">&#39;quantile_grouped.csv&#39;</span><span class="p">)</span>

<span class="n">deciles_grouped</span> <span class="o">=</span> <span class="n">deciles_agg</span><span class="p">(</span><span class="n">df_input</span><span class="p">,</span><span class="n">grp</span><span class="p">,</span><span class="n">num_cols</span><span class="p">)</span>
<span class="n">deciles_grouped</span><span class="o">.</span><span class="n">toPandas</span><span class="p">()</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">output_dir</span><span class="o">+</span><span class="s1">&#39;deciles_grouped.csv&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="textmining.html" class="btn btn-neutral float-right" title="14. Text Mining" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="clustering.html" class="btn btn-neutral float-left" title="12. Clustering" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, Wenqiang Feng
      <span class="lastupdated">
        Last updated on Dec 27, 2021.
      </span>

    </p>
  </div> 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>